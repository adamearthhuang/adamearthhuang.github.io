<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WireGuard | 黄宝权</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script type="text/javascript" src="/assets/js/push.js"></script>
    <script type="text/javascript" src="/assets/js/hm.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&amp;display=swap">
    <meta name="description" content="">
    <meta name="baidu-site-verification" content="code-FacPXl4enQ">
    
    <link rel="preload" href="/assets/css/0.styles.b2c978f0.css" as="style"><link rel="preload" href="/assets/js/app.288e09f5.js" as="script"><link rel="preload" href="/assets/js/2.ea342f57.js" as="script"><link rel="preload" href="/assets/js/4.5ec22d0a.js" as="script"><link rel="prefetch" href="/assets/js/10.90a9e338.js"><link rel="prefetch" href="/assets/js/11.c17a439b.js"><link rel="prefetch" href="/assets/js/12.b984e22e.js"><link rel="prefetch" href="/assets/js/13.e13b5de8.js"><link rel="prefetch" href="/assets/js/14.a5d6e7b8.js"><link rel="prefetch" href="/assets/js/15.1cd751f2.js"><link rel="prefetch" href="/assets/js/16.1db6ee10.js"><link rel="prefetch" href="/assets/js/17.92348793.js"><link rel="prefetch" href="/assets/js/18.2d2294a9.js"><link rel="prefetch" href="/assets/js/19.85fc5086.js"><link rel="prefetch" href="/assets/js/20.f9ec9e58.js"><link rel="prefetch" href="/assets/js/21.b6e78e78.js"><link rel="prefetch" href="/assets/js/22.414c27e4.js"><link rel="prefetch" href="/assets/js/23.4dbc66f8.js"><link rel="prefetch" href="/assets/js/24.f9680251.js"><link rel="prefetch" href="/assets/js/25.116a662a.js"><link rel="prefetch" href="/assets/js/26.1bf01420.js"><link rel="prefetch" href="/assets/js/27.dc8ab273.js"><link rel="prefetch" href="/assets/js/28.af7754e1.js"><link rel="prefetch" href="/assets/js/29.0b19dbd2.js"><link rel="prefetch" href="/assets/js/3.d98b8f16.js"><link rel="prefetch" href="/assets/js/30.3731e0a9.js"><link rel="prefetch" href="/assets/js/31.0d76db53.js"><link rel="prefetch" href="/assets/js/32.a666116e.js"><link rel="prefetch" href="/assets/js/33.27aee251.js"><link rel="prefetch" href="/assets/js/34.70c96ce8.js"><link rel="prefetch" href="/assets/js/35.622c1d84.js"><link rel="prefetch" href="/assets/js/36.f8087f8b.js"><link rel="prefetch" href="/assets/js/37.8cff0ff1.js"><link rel="prefetch" href="/assets/js/38.d201b410.js"><link rel="prefetch" href="/assets/js/39.2ea46627.js"><link rel="prefetch" href="/assets/js/40.3c2adbf6.js"><link rel="prefetch" href="/assets/js/41.5762af48.js"><link rel="prefetch" href="/assets/js/42.5579401a.js"><link rel="prefetch" href="/assets/js/43.a9adbc7f.js"><link rel="prefetch" href="/assets/js/44.1c441e13.js"><link rel="prefetch" href="/assets/js/45.dd604ce3.js"><link rel="prefetch" href="/assets/js/46.a0c494a9.js"><link rel="prefetch" href="/assets/js/47.500221cc.js"><link rel="prefetch" href="/assets/js/5.0bc15ad1.js"><link rel="prefetch" href="/assets/js/6.bb2a4e48.js"><link rel="prefetch" href="/assets/js/7.4431ae5e.js"><link rel="prefetch" href="/assets/js/8.13ade83d.js"><link rel="prefetch" href="/assets/js/9.68a03aed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b2c978f0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-af323418><header class="header" data-v-69452f20 data-v-af323418><div class="title" data-v-69452f20>黄宝权</div></header> <nav class="navs" data-v-38628940 data-v-af323418></nav> <div class="search-box" data-v-10b1314e data-v-af323418><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-10b1314e> <!----></div> <div class="tags" data-v-1272fba8 data-v-af323418><div class="tag" data-v-1272fba8><a data-v-1272fba8>Git</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>Java</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>JavaScript</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>Linux</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>MySQL</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>Node.js</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>Web</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>操作系统</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>数据分析</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>数据库</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>数据结构</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>机器学习</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>爬虫</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>算法</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>编程语言</a></div><div class="tag" data-v-1272fba8><a data-v-1272fba8>网络</a></div></div> <main data-v-af323418><div data-v-e4554dac data-v-af323418><!----> <div class="content__default" data-v-e4554dac><h1 id="wireguard"><a href="#wireguard" class="header-anchor">#</a> WireGuard</h1> <p><img src="/assets/img/01.3c3d3425.png" alt=""></p> <p><a href="https://github.com/pirate/wireguard-docs" target="_blank" rel="noopener noreferrer">WireGuard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个易于配置、快速且安全的开源 VPN，它利用了最新的加密技术 —— ECDH 算法，提供一种更快、更简单、更安全的通用 VPN，WireGuard 被视为下一代 VPN 协议，用来替代 OpenVPN、IPSec 等，并且它可以轻松地在树莓派这类低端设备到高端服务器上部署，当前已经被吸收进了 Linux 5.6+ 的内核中，总共只有不到四千行代码。</p> <p>WireGuard 最初是为 Linux 开发的，但现在可用于 Windows、macOS、iOS 和 Android 等平台上。</p> <h2 id="性能对比"><a href="#性能对比" class="header-anchor">#</a> 性能对比</h2> <p><img src="/assets/img/02.55b56a64.jpg" alt=""></p> <h2 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h2> <h3 id="连接过程"><a href="#连接过程" class="header-anchor">#</a> 连接过程</h3> <p><img src="/assets/img/03.01a70dff.png" alt=""></p> <p>正常情况下，WireGuard 只需要 1 个 RTT 的握手就会建立连接状态，然后就开始传输数据了。在握手的过程中交换了对称密钥，一个用来发送，一个用来接收，并且在路由表中生成了对方的地址。</p> <blockquote><p>在负载较重的时候，WireGuard 会要求 2 个 RTT 的握手。</p></blockquote> <p>一、握手请求报文：</p> <ul><li>unencrypted_ephemeral：发送方为这次握手临时生成的公钥（未加密，用于 ECDH）</li> <li>encrypted_static：用对方的公钥和临时生成的私钥 ECDH 出的临时密钥 key1 对称加密对方的公钥</li> <li>encrypted_timestamp：用对方的公钥和自己的私钥 ECDH 出 key2，key2 混淆进 key1，来加密当前的时间戳</li> <li>mac1：对方的公钥加上整个报文内容后的哈希</li></ul> <p>二、握手回复报文：</p> <ul><li>unencrypted_ephemeral：接收方为这次握手临时生成的公钥（未加密，用于 ECDH）</li> <li>mac1：对方的公钥加上整个报文内容后的哈希</li></ul> <p>这样两端都有对方的临时生成的公钥，加上自己临时生成的私钥，就可以 ECDH + HKDF（一种把 DH 结果转成对称加密密钥的方法）得到这次握手的两个方向的对称加密的密钥。</p> <h3 id="传输过程"><a href="#传输过程" class="header-anchor">#</a> 传输过程</h3> <p><img src="/assets/img/04.24151f0f.png" alt=""></p> <p>WireGuard 以 UDP 实现，但是运行在第三层 —— IP 层（网络层）。每个 WireGuard Peer（节点） 都会生成一个 <code>wg0</code> 虚拟网卡。应用程序的包发送到内核以后，如果地址是虚拟专用网内部的，那么就会交给 <code>wg0</code> 设备，WireGuard 就会把这个 IP 包封装成 WireGuard 的包，然后在 UDP 中发送出去，对方的 Peer 的内核收到这个 UDP 包后再反向操作，解包成为 IP 包，然后交给对应的应用程序。</p> <h2 id="配置方法"><a href="#配置方法" class="header-anchor">#</a> 配置方法</h2> <p><img src="/assets/img/05.7b9fb557.jpeg" alt=""></p> <h3 id="公私钥"><a href="#公私钥" class="header-anchor">#</a> 公私钥</h3> <div class="language- extra-class"><pre class="language-text"><code># 每一个节点都需要生成一对公私钥
wg genkey | tee private | wg pubkey &gt; public
</code></pre></div><h3 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h3> <div class="language-conf extra-class"><pre class="language-text"><code># /etc/wireguard/wg0.conf

[Interface]
# 服务端私钥
PrivateKey =
Address = 10.10.10.1
SaveConfig = true
ListenPort = 51820
PostUp   = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE


# 配置客户端的 IP（多个客户端连接用多个 Peer 来配置）
[Peer]
# 客户端公钥
PublicKey =
# 表示只代理该 IP 过来的流量（支持网段）
AllowedIPs = 10.10.10.2/32
# 表示代理所有流量
# AllowedIPs = 0.0.0.0/0
</code></pre></div><h3 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h3> <div class="language-conf extra-class"><pre class="language-text"><code>[Interface]
# 客户端私钥
PrivateKey =
Address = 10.10.10.2/32
DNS = 8.8.8.8

[Peer]
# 服务端公钥
PublicKey =
# 服务端公网地址
Endpoint = 149.28.171.194:51820
# 表示只劫持该 IP 的流量（支持网段）
AllowedIPs = 10.100.0.0/16,172.17.0.11/20
# 表示劫持所有流量
# AllowedIPs = 0.0.0.0/0
</code></pre></div></div></div></main> <footer data-v-81a5c08c data-v-af323418></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.288e09f5.js" defer></script><script src="/assets/js/2.ea342f57.js" defer></script><script src="/assets/js/4.5ec22d0a.js" defer></script>
  </body>
</html>
